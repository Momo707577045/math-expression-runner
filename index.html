<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="author" content="毛静文,Momo">
  <meta name="keywords" content="数学运算器,毛静文的博客,Momo's Blog">
  <meta name="description" content="在线数学运算器，程序员运算器，无按钮运算器，字符串计算器">
  <title>数学运算器</title>
  <style>
    /*全局设置*/
    body::-webkit-scrollbar {
      display: none
    }

    p {
      margin: 0;
    }

    [v-cloak] {
      display: none;
    }

    html,
    body,
    #app {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: #fff;
    }

    #app {
      padding: 10px 50px 0;
      box-sizing: border-box;
    }

    .iframe-mode {
      padding: 0 !important;
    }

    .p-action {
      margin: 20px auto;
      max-width: 1100px;
      width: 100%;
      font-size: 35px;
      text-align: center;
      font-weight: bold;
      white-space: pre-line;
    }

    .p-github,
    .p-tamper,
    .p-other {
      position: fixed;
      right: 50px;
      bottom: 110px;
      background-color: #eff3f6;
      background-image: linear-gradient(-180deg, #fafbfc, #eff3f6 90%);
      color: #24292e;
      border: 1px solid rgba(27, 31, 35, .2);
      border-radius: 3px;
      cursor: pointer;
      display: inline-block;
      font-size: 14px;
      font-weight: 600;
      line-height: 20px;
      padding: 6px 12px;
      z-index: 2;
    }

    .p-help {
      position: fixed;
      right: 50px;
      top: 50px;
      width: 30px;
      height: 30px;
      color: #666666;
      z-index: 2;
      line-height: 30px;
      font-weight: bolder;
      border-radius: 50%;
      border: 1px solid rgba(27, 31, 35, .2);
      cursor: pointer;
      background-color: #eff3f6;
      background-image: linear-gradient(-180deg, #fafbfc, #eff3f6 90%);
    }

    .p-github:hover,
    .p-other:hover,
    .p-tamper:hover,
    .p-help {
      opacity: 0.9;
    }

    .p-other {
      bottom: 30px;
    }

    .p-tamper {
      bottom: 70px;
    }

    .result-box {
      display: flex;
      width: 100%;
      overflow-x: auto;
      justify-content: space-between;
    }

    .result-box div {
      display: inline-block;
      height: 20px;
      font-size: 16px;
      line-height: 20px;
      font-weight: bold;
    }

    .result-box>div {
      padding: 10px 0;
      white-space: pre;
    }

    .result-box .left div {
      margin-right: 20px;
      white-space: pre;
    }

    .result-box .right div, .btn {
      margin-top: -4px;
      margin-left: 20px;
      display: inline-block;
      font-size: 14px;
      color: white;
      padding: 4px 8px;
      text-align: center;
      min-width: 10px;
      cursor: pointer;
      border-radius: 4px;
      background-color: #3D8AC7;
    }

    .result-box .right div:nth-child(1) {
      margin-left: 0 !important;
    }

    /*字体文件载入*/
    .textarea-box {
      padding: 10px;
      box-sizing: border-box;
      height: calc(100% - 150px);
      width: 100%;
      position: relative;
      white-space: pre;
      text-align: left;
      color: #333333;
      vertical-align: text-top;
      font-size: 14px;
      line-height: 16px;
      overflow: auto;
      border-radius: 4px;
      font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
      border: 1px solid #cccccc;
      resize: none;
    }

    .contenteditable-box {
      padding: 10px;
      box-sizing: border-box;
      height: calc(100% - 150px);
      width: 100%;
      position: relative;
      white-space: pre-wrap;
      text-align: left;
      color: #333333;
      vertical-align: text-top;
      font-size: 14px;
      line-height: 16px;
      overflow: auto;
      border-radius: 4px;
      font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
      border: 1px solid #cccccc;
      resize: none;
      outline: none;
    }

    .contenteditable-box:empty:before {
      content: attr(data-placeholder);
      color: #999;
      pointer-events: none;
    }

    .number-highlight {
      background-color: #7BD784;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 2px;
    }

    .number-highlight:hover {
      background-color: #7BD784;
    }

    .number-selected {
      background-color: #ccc !important;
      color: black !important;
      opacity: 0.5;
      text-decoration: line-through;
    }

    .number-selected:hover {
      background-color: #d0d0d0 !important;
      opacity: 0.6;
    }

    .iframe-mode {
      padding: 0;
    }

    .iframe-mode .textarea-box,
    .iframe-mode .contenteditable-box {
      height: calc(100% - 20px);
    }

    .iframe-mode .result-box div {
      margin: 0;
      padding-top: 0;
      padding-bottom: 0;
      font-size: 14px;
    }

    .iframe-mode .textarea-box,
    .iframe-mode .contenteditable-box {
      border: 0;
      padding: 4px 8px;
      border-top: 1px solid #cccccc;
    }
  </style>
</head>

<body>
  <div id="loading">
    页面加载中，请耐心等待...
    <h1 style="white-space: pre;">
      推荐一个数学运算工具
      【】支持换行
      【】支持划区选中计算，如 1 + 2 * 3 中，选中 2 * 3 则得 6
      【】支持省略操作符，数字间默认执行 “加” 操作，如 1 2 3 则得 6
      工具链接：https://blog.luckly-mjw.cn/tool-show/json-remark-parse/index.html
    </h1>
  </div>
  <section id="app" v-cloak="" :class="{'iframe-mode': iframeMode }">
    <!--顶部操作提示-->
    <template v-if="!iframeMode">
      <section class="p-action g-box">{{ tips }}</section>
      <a class="p-github" target="_blank" href="https://github.com/Momo707577045/math-expression-runner">github</a>
      <a class="p-tamper" target="_blank"
        href="https://blog.luckly-mjw.cn/tool-show/math-expression-runner/math-expression-runner.user.js">油猴插件</a>
      <a class="p-other" target="_blank" href="http://blog.luckly-mjw.cn/tool-show/index.html">其他实用工具</a>
    </template>

    <div class="result-box">
      <div class="left">
        <template v-if="!iframeMode">
          <div v-if="isShowSourceExp" :title="sourceExp">表达式值: {{sourceResult}} = {{ sourceExp }}</div>
          <div>选区值: {{selectedResult}} = {{ selectedExp }}</div>
        </template>
        <template v-else>
          <div v-if="!selectedStr">{{sourceResult}} = {{ sourceExp }}</div>
          <div v-else>{{selectedResult}} = {{ selectedExp }}</div>
        </template>
      </div>

      <div class="right">
        <div @click="showSourceExp" >仅划屏</div>
        <div @click="format" v-if="!iframeMode">格式化</div>
        <div @click="jump" v-if="iframeMode">全屏</div>
        <div v-if="iframeMode">关闭</div>
      </div>
    </div>
    <div 
      ref="contentEditableBox"
      contenteditable="true" 
      class="contenteditable-box" 
      @input="handleInput"
      @paste="handlePaste"
      @keydown="handleKeydown"
      :data-placeholder="testStr"
    ></div>
  </section>
</body>
<script>
  var _hmt = _hmt || [];
  (function () {
    var hm = document.createElement("script")
    hm.src = "https://hm.baidu.com/hm.js?1f12b0865d866ae1b93514870d93ce89"
    var s = document.getElementsByTagName("script")[0]
    s.parentNode.insertBefore(hm, s)
  })();
</script>
<!--vue 前端框架-->
<script src="https://upyun.luckly-mjw.cn/lib/vue.js"></script>
<script>
  document.getElementById('loading') && document.getElementById('loading').remove()
  document.addEventListener("selectionchange", (event) => {
    const selection = window.getSelection();
    const originalText = selection.toString();
    const selectedText = originalText.trim();
    if (selectedText && window.vueInstance) {
      // 检查选中的文本是否来自 contenteditable
      const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
      if (range) {
        const container = range.commonAncestorContainer;
        const contentEditableBox = window.vueInstance.$refs.contentEditableBox;
        if (contentEditableBox && (contentEditableBox.contains(container) || contentEditableBox === container)) {
          // 排除点击数字高亮的情况
          if (!container.parentElement?.classList?.contains('number-highlight')) {
            // 计算选区的起始位置
            const preCaretRange = document.createRange();
            preCaretRange.selectNodeContents(contentEditableBox);
            preCaretRange.setEnd(range.startContainer, range.startOffset);
            // 计算前导空白的长度（因为 selectedText 被 trim 了）
            const leadingWhitespace = originalText.length - originalText.trimStart().length;
            const startOffset = preCaretRange.toString().length + leadingWhitespace;
            
            window.vueInstance.$data.selectedStr = selectedText;
            window.vueInstance.$data.selectedOffset = startOffset;
          }
        }
      }
    }
  });
  window.vueInstance = new Vue({
    el: '#app',

    data() {
      return {
        tips: '快速数学运算器',
        iframeMode: window.parent !== window, // 是否使用 iframe 简洁模式
        // iframeMode: true, // 是否使用 iframe 简洁模式
        sourceStr: localStorage.getItem('math-expression-runner_sourceStr') || '', // 源码字符串
        isShowSourceExp: localStorage.getItem('math-expression-runner_isShowSourceExp') !== 'false', // 是否显示表达式
        sourceExp: '', // 源码字符串的数学表达式
        sourceResult: '', // 整个运算结果
        selectedStr: '', // 选中的字符串
        selectedOffset: 0, // 选中字符串在源字符串中的起始位置
        selectedExp: '', // 选中的字符串的数学表达式
        selectedResult: '', // 选中的表达式的运算结果
        selectedNumbers: new Set(), // 选中的数字索引集合（存储位置索引，而不是数字值）
        numbersList: [], // 所有数字的列表，包含位置和值信息
        highlightTimeout: null, // 高亮更新的定时器
        isEditing: false, // 是否正在编辑中
        pendingHighlight: false, // 是否有待处理的高亮更新
        testStr: `请输入数学运算表达式，如 1 + 2 * 3
【】支持换行
【】支持划区选中计算，如 1 + 2 * 3 中，选中 2 * 3 则得 6
【】支持省略操作符，数字间默认执行 “加” 操作，如 1 2 3 则得 6
`,
      }
    },

    watch: {
      sourceStr: function (newValue) {
        localStorage.setItem('math-expression-runner_sourceStr', newValue)
        this.selectedStr = '';
        // 当内容变化时，清空选中状态（因为数字位置可能已变化）
        this.selectedNumbers.clear();
        
        // 更新数字列表（不重建 DOM），供 run 方法使用
        const text = this.iframeMode ? newValue.replace(/\n/ig, ' ') : newValue;
        const numberRegex = /(\d+\.?\d*)/g;
        let match;
        const numbers = [];
        while ((match = numberRegex.exec(text)) !== null) {
          numbers.push({
            value: match[0],
            index: match.index,
            length: match[0].length
          });
        }
        this.numbersList = numbers;
        
        // 计算表达式（不等待高亮更新）
        ({
          exp: this.sourceExp,
          value: this.sourceResult,
        } = this.run(newValue));
        
        // 如果不是正在编辑，则立即更新 DOM
        if (!this.isEditing) {
          this.$nextTick(() => {
            const displayValue = this.iframeMode ? newValue.replace(/\n/ig, ' ') : newValue;
            const box = this.$refs.contentEditableBox;
            if (box && box.textContent !== displayValue) {
              box.textContent = displayValue;
            }
            this.highlightNumbers();
          });
        }
      },
      selectedStr: function (newValue) {
        // 传入 selectedOffset 用于正确过滤选区内的数字
        ({
          exp: this.selectedExp,
          value: this.selectedResult,
        } = this.run(newValue, this.selectedOffset));
      },
    },

    mounted() {
      ({
        exp: this.sourceExp,
        value: this.sourceResult,
      } = this.run(new URL(location.href).searchParams.get('sourceStr') || this.sourceStr));
      // 从 URL 参数中提取传参
      // 考虑 iframe 的嵌入式使用方式
      // 初始化高亮显示
      this.$nextTick(() => {
        this.updateContentEditable();
        this.highlightNumbers();
      });
    },

    methods: {
      // 更新 contenteditable 的内容
      updateContentEditable() {
        const box = this.$refs.contentEditableBox;
        if (box) {
          const displayValue = this.iframeMode ? this.sourceStr.replace(/\n/ig, ' ') : this.sourceStr;
          if (box.textContent !== displayValue) {
            box.textContent = displayValue;
          }
        }
      },

      // 处理输入事件
      handleInput(event) {
        const box = this.$refs.contentEditableBox;
        // 获取纯文本内容，确保正确处理 DOM 结构
        const text = this.getPlainText(box);
        
        // 标记正在编辑
        this.isEditing = true;
        
        // 更新 sourceStr
        this.sourceStr = text;
        
        // 使用防抖延迟高亮更新，避免频繁重建 DOM
        if (this.highlightTimeout) {
          clearTimeout(this.highlightTimeout);
        }
        this.pendingHighlight = true;
        this.highlightTimeout = setTimeout(() => {
          this.isEditing = false;
          this.pendingHighlight = false;
          this.highlightNumbers();
        }, 300); // 300ms 防抖延迟
      },

      // 获取纯文本内容（处理复杂 DOM 结构，保留换行）
      getPlainText(element) {
        // 使用 innerText 可以正确处理换行（<br>、<div> 等会被转换为 \n）
        // 但 innerText 会触发重排，性能略差
        // 这里使用 innerText 以确保换行符被正确保留
        return element.innerText || '';
      },

      // 处理粘贴事件
      handlePaste(event) {
        event.preventDefault();
        const text = (event.clipboardData || window.clipboardData).getData('text');
        document.execCommand('insertText', false, text);
      },

      // 处理键盘事件
      handleKeydown(event) {
        // 允许 Tab 键插入制表符
        if (event.key === 'Tab') {
          event.preventDefault();
          document.execCommand('insertText', false, '  ');
        }
      },

      // 高亮显示数字
      highlightNumbers() {
        const box = this.$refs.contentEditableBox;
        if (!box) return;
        
        // 如果正在编辑中，不进行高亮更新（除非是延迟触发的）
        if (this.isEditing && !this.pendingHighlight) {
          return;
        }

        // 使用 sourceStr 作为数据源，确保与 run 方法一致
        const text = this.iframeMode ? this.sourceStr.replace(/\n/ig, ' ') : this.sourceStr;
        const numberRegex = /(\d+\.?\d*)/g;
        let match;
        const numbers = [];
        
        // 找到所有数字及其位置
        while ((match = numberRegex.exec(text)) !== null) {
          numbers.push({
            value: match[0],
            index: match.index,
            length: match[0].length
          });
        }
        
        // 保存数字列表，供 run 方法使用
        this.numbersList = numbers;

        // 保存当前光标位置
        const selection = window.getSelection();
        let range = null;
        let cursorOffset = 0;
        
        if (selection.rangeCount > 0) {
          range = selection.getRangeAt(0).cloneRange();
          // 计算光标在文本中的偏移量
          const preCaretRange = range.cloneRange();
          preCaretRange.selectNodeContents(box);
          preCaretRange.setEnd(range.startContainer, range.startOffset);
          cursorOffset = preCaretRange.toString().length;
        }
        
        // 重新构建 HTML
        let html = '';
        let lastIndex = 0;
        let htmlOffset = 0; // HTML 中的字符偏移量
        
        numbers.forEach((num, idx) => {
          // 添加数字前的文本
          const beforeText = text.substring(lastIndex, num.index);
          html += this.escapeHtml(beforeText);
          htmlOffset += beforeText.length;
          
          // 添加数字（带高亮）- 使用索引来判断是否选中
          const isSelected = this.selectedNumbers.has(idx);
          const className = isSelected ? 'number-highlight number-selected' : 'number-highlight';
          html += `<span class="${className}" data-number="${this.escapeHtml(num.value)}" data-index="${idx}">${this.escapeHtml(num.value)}</span>`;
          htmlOffset += num.value.length;
          
          lastIndex = num.index + num.length;
        });
        
        // 添加剩余文本
        html += this.escapeHtml(text.substring(lastIndex));
        
        box.innerHTML = html;
        
        // 恢复光标位置（简化版本，在文本末尾）
        if (range && cursorOffset > 0) {
          try {
            // 尝试将光标设置到接近原位置
            const walker = document.createTreeWalker(
              box,
              NodeFilter.SHOW_TEXT,
              null
            );
            let currentOffset = 0;
            let targetNode = null;
            let targetOffset = 0;
            
            let node;
            while (node = walker.nextNode()) {
              const nodeLength = node.textContent.length;
              if (currentOffset + nodeLength >= cursorOffset) {
                targetNode = node;
                targetOffset = cursorOffset - currentOffset;
                break;
              }
              currentOffset += nodeLength;
            }
            
            if (targetNode) {
              const newRange = document.createRange();
              newRange.setStart(targetNode, Math.min(targetOffset, targetNode.textContent.length));
              newRange.collapse(true);
              selection.removeAllRanges();
              selection.addRange(newRange);
            }
          } catch (e) {
            // 如果恢复失败，将光标放在末尾
            const newRange = document.createRange();
            newRange.selectNodeContents(box);
            newRange.collapse(false);
            selection.removeAllRanges();
            selection.addRange(newRange);
          }
        }
        
        // 绑定点击事件（使用改进的方式）
        this.bindNumberClickEvents();
      },

      // 转义 HTML
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },

      // 绑定数字点击事件
      bindNumberClickEvents() {
        const box = this.$refs.contentEditableBox;
        if (!box) return;

        const numberSpans = box.querySelectorAll('.number-highlight');
        numberSpans.forEach(span => {
          // 使用双击来触发数字的选中/取消选中
          // 单击用于定位光标进行编辑
          span.addEventListener('dblclick', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const numberIndex = parseInt(span.getAttribute('data-index'), 10);
            this.toggleNumberSelection(numberIndex);
          });
        });
      },

      // 切换数字选中状态（使用索引）
      toggleNumberSelection(numberIndex) {
        if (this.selectedNumbers.has(numberIndex)) {
          this.selectedNumbers.delete(numberIndex);
        } else {
          this.selectedNumbers.add(numberIndex);
        }
        // 重新高亮
        this.highlightNumbers();
        // 重新计算表达式（因为被选中的数字会影响计算结果）
        ({
          exp: this.sourceExp,
          value: this.sourceResult,
        } = this.run(this.sourceStr));
        // 如果当前有选中文本，也重新计算（传入 selectedOffset）
        if (this.selectedStr) {
          ({
            exp: this.selectedExp,
            value: this.selectedResult,
          } = this.run(this.selectedStr, this.selectedOffset));
        }
      },

      showSourceExp() {
        this.isShowSourceExp = !this.isShowSourceExp;
        localStorage.setItem('math-expression-runner_isShowSourceExp', this.isShowSourceExp)
      },

       // 拷贝剪切板
      copyToClipboard(content) {

        if (!document.queryCommandSupported('copy')) {
          return false
        }

        let $input = document.createElement('textarea')
        $input.style.opacity = '0'
        $input.value = content
        document.body.appendChild($input)
        $input.select()

        const result = document.execCommand('copy')
        document.body.removeChild($input)
        $input = null

        return result
      },

      jump() {
        window.open('https://blog.luckly-mjw.cn/tool-show/math-expression-runner/index.html?sourceResult=' + this.sourceStr);
      },

      // 重排版，替换换行符
      format() {
        this.sourceStr = this.sourceStr.replace(/\n/ig, ' ').replace(/[ ]+/ig, ' ');
        this.$nextTick(() => {
          this.updateContentEditable();
          this.highlightNumbers();
        });
      },

      // 运行
      // offset: 目标字符串在源字符串中的起始位置偏移量（用于选区计算）
      run(targetStr, offset = 0) {
        // 获取被选中（置灰）的数字索引集合
        const disabledIndexes = this.selectedNumbers || new Set();
        const numbersList = this.numbersList || [];
        
        // 如果字符串为空，直接返回
        if (!targetStr) {
          return {
            exp: '',
            value: '',
          }
        }

        // 根据索引位置移除被选中的数字
        let processedStr = targetStr;
        if (disabledIndexes.size > 0 && numbersList.length > 0) {
          // 找出在目标字符串范围内且被选中的数字
          const numbersInRange = [];
          disabledIndexes.forEach(idx => {
            const numInfo = numbersList[idx];
            if (numInfo) {
              // 计算相对于目标字符串的位置
              const relativeIndex = numInfo.index - offset;
              // 检查数字是否在目标字符串的范围内
              if (relativeIndex >= 0 && relativeIndex + numInfo.length <= targetStr.length) {
                // 验证该位置的数字值是否匹配（确保位置正确）
                const valueAtPosition = targetStr.substring(relativeIndex, relativeIndex + numInfo.length);
                if (valueAtPosition === numInfo.value) {
                  numbersInRange.push({
                    ...numInfo,
                    relativeIndex: relativeIndex
                  });
                }
              }
            }
          });
          
          // 从后往前替换，避免位置偏移问题
          numbersInRange.sort((a, b) => b.relativeIndex - a.relativeIndex);
          numbersInRange.forEach(numInfo => {
            const before = processedStr.substring(0, numInfo.relativeIndex);
            const after = processedStr.substring(numInfo.relativeIndex + numInfo.length);
            processedStr = before + ' ' + after;
          });
          
          // 清理多余的空格和连续的操作符
          // 移除连续的空格
          processedStr = processedStr.replace(/\s+/g, ' ');
          // 清理开头和结尾的空格
          processedStr = processedStr.trim();
        }

        const regex = /[\d\.+\-*/()\s]+/g;
        let preKeyIsNum = false
        let defaultAction = '+'
        const mathStr = processedStr.match(regex)?.join(' ').replace(/\n/ig, ' ').split(' ').map((key => {
          key = key.trim();
          let result = key
          if (!key) {
            return ''
          }
          // 如果上一个是数字，且现在也以数字开头，则添加操作符
          if (/\d/.test(key[0]) && preKeyIsNum) {
            result = defaultAction + key
          }
          preKeyIsNum = /\d/.test(key.slice(-1)[0]) // 最后一位是否是数字
          return result
        })).join('');

        // 输出结果
        try {
          targetStr && window.history.replaceState(null, '', `${location.href.split('?')[0]}?sourceResult=${targetStr}`)
          return {
            exp: mathStr,
            value: mathStr ? eval(mathStr) : '',
          }
        } catch (error) {
          return {
            exp: mathStr,
            value: '表达式错误',
          }
        }
      },
    },
  })
</script>

</html>