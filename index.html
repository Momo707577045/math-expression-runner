<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="author" content="毛静文,Momo">
  <meta name="keywords" content="数学运算器,毛静文的博客,Momo's Blog">
  <meta name="description" content="在线数学运算器，程序员运算器，无按钮运算器，字符串计算器">
  <title>数学运算器</title>
  <style>
    /*全局设置*/
    body::-webkit-scrollbar {
      display: none
    }

    p {
      margin: 0;
    }

    [v-cloak] {
      display: none;
    }

    html,
    body,
    #app {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: #fff;
    }

    #app {
      padding: 10px 50px 0;
      box-sizing: border-box;
    }

    .iframe-mode {
      padding: 0 !important;
    }

    .p-action {
      margin: 20px auto;
      max-width: 1100px;
      width: 100%;
      font-size: 35px;
      text-align: center;
      font-weight: bold;
      white-space: pre-line;
    }

    .p-github,
    .p-tamper,
    .p-other {
      position: fixed;
      right: 50px;
      bottom: 110px;
      background-color: #eff3f6;
      background-image: linear-gradient(-180deg, #fafbfc, #eff3f6 90%);
      color: #24292e;
      border: 1px solid rgba(27, 31, 35, .2);
      border-radius: 3px;
      cursor: pointer;
      display: inline-block;
      font-size: 14px;
      font-weight: 600;
      line-height: 20px;
      padding: 6px 12px;
      z-index: 2;
    }

    .p-help {
      position: fixed;
      right: 50px;
      top: 50px;
      width: 30px;
      height: 30px;
      color: #666666;
      z-index: 2;
      line-height: 30px;
      font-weight: bolder;
      border-radius: 50%;
      border: 1px solid rgba(27, 31, 35, .2);
      cursor: pointer;
      background-color: #eff3f6;
      background-image: linear-gradient(-180deg, #fafbfc, #eff3f6 90%);
    }

    .p-github:hover,
    .p-other:hover,
    .p-tamper:hover,
    .p-help {
      opacity: 0.9;
    }

    .p-other {
      bottom: 30px;
    }

    .p-tamper {
      bottom: 70px;
    }

    .result-box {
      display: flex;
      width: 100%;
      overflow-x: auto;
      justify-content: space-between;
    }

    .result-box div {
      display: inline-block;
      height: 20px;
      font-size: 16px;
      line-height: 20px;
      font-weight: bold;
    }

    .result-box>div {
      padding: 10px 0;
      white-space: pre;
    }

    .result-box .left div {
      margin-right: 20px;
      white-space: pre;
    }

    .result-box .right div, .btn {
      margin-top: -4px;
      margin-left: 20px;
      display: inline-block;
      font-size: 14px;
      color: white;
      padding: 4px 8px;
      text-align: center;
      min-width: 10px;
      cursor: pointer;
      border-radius: 4px;
      background-color: #3D8AC7;
    }

    .result-box .right div:nth-child(1) {
      margin-left: 0 !important;
    }

    /*字体文件载入*/
    .textarea-box {
      padding: 10px;
      box-sizing: border-box;
      height: calc(100% - 150px);
      width: 100%;
      position: relative;
      white-space: pre;
      text-align: left;
      color: #333333;
      vertical-align: text-top;
      font-size: 14px;
      line-height: 16px;
      overflow: auto;
      border-radius: 4px;
      font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
      border: 1px solid #cccccc;
      resize: none;
    }

    .contenteditable-box {
      padding: 10px;
      box-sizing: border-box;
      height: calc(100% - 150px);
      width: 100%;
      position: relative;
      white-space: pre-wrap;
      text-align: left;
      color: #333333;
      vertical-align: text-top;
      font-size: 14px;
      line-height: 16px;
      overflow: auto;
      border-radius: 4px;
      font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
      border: 1px solid #cccccc;
      resize: none;
      outline: none;
    }

    .contenteditable-box:empty:before {
      content: attr(data-placeholder);
      color: #999;
      pointer-events: none;
    }

    .number-highlight {
      background-color: #fff3cd;
      cursor: pointer;
      padding: 2px 0;
      border-radius: 2px;
      transition: background-color 0.2s;
    }

    .number-highlight:hover {
      background-color: #ffe69c;
    }

    .number-selected {
      background-color: #4CAF50 !important;
      color: white;
      font-weight: bold;
    }

    .number-selected:hover {
      background-color: #45a049 !important;
    }

    .iframe-mode {
      padding: 0;
    }

    .iframe-mode .textarea-box,
    .iframe-mode .contenteditable-box {
      height: calc(100% - 20px);
    }

    .iframe-mode .result-box div {
      margin: 0;
      padding-top: 0;
      padding-bottom: 0;
      font-size: 14px;
    }

    .iframe-mode .textarea-box,
    .iframe-mode .contenteditable-box {
      border: 0;
      padding: 4px 8px;
      border-top: 1px solid #cccccc;
    }
  </style>
</head>

<body>
  <div id="loading">
    页面加载中，请耐心等待...
    <h1 style="white-space: pre;">
      推荐一个数学运算工具
      【】支持换行
      【】支持划区选中计算，如 1 + 2 * 3 中，选中 2 * 3 则得 6
      【】支持省略操作符，数字间默认执行 “加” 操作，如 1 2 3 则得 6
      工具链接：https://blog.luckly-mjw.cn/tool-show/json-remark-parse/index.html
    </h1>
  </div>
  <section id="app" v-cloak="" :class="{'iframe-mode': iframeMode }">
    <!--顶部操作提示-->
    <template v-if="!iframeMode">
      <section class="p-action g-box">{{ tips }}</section>
      <a class="p-github" target="_blank" href="https://github.com/Momo707577045/math-expression-runner">github</a>
      <a class="p-tamper" target="_blank"
        href="https://blog.luckly-mjw.cn/tool-show/math-expression-runner/math-expression-runner.user.js">油猴插件</a>
      <a class="p-other" target="_blank" href="http://blog.luckly-mjw.cn/tool-show/index.html">其他实用工具</a>
    </template>

    <div class="result-box">
      <div class="left">
        <template v-if="!iframeMode">
          <div v-if="isShowSourceExp" :title="sourceExp">表达式值: {{sourceResult}} = {{ sourceExp }}</div>
          <div>选区值: {{selectedResult}} = {{ selectedExp }}</div>
        </template>
        <template v-else>
          <div v-if="!selectedStr">{{sourceResult}} = {{ sourceExp }}</div>
          <div v-else>{{selectedResult}} = {{ selectedExp }}</div>
        </template>
      </div>

      <div class="right">
        <div @click="showSourceExp" >仅划屏</div>
        <div @click="format" v-if="!iframeMode">格式化</div>
        <div @click="jump" v-if="iframeMode">全屏</div>
        <div v-if="iframeMode">关闭</div>
      </div>
    </div>
    <div 
      ref="contentEditableBox"
      contenteditable="true" 
      class="contenteditable-box" 
      @input="handleInput"
      @paste="handlePaste"
      @keydown="handleKeydown"
      :data-placeholder="testStr"
    ></div>
  </section>
</body>
<script>
  var _hmt = _hmt || [];
  (function () {
    var hm = document.createElement("script")
    hm.src = "https://hm.baidu.com/hm.js?1f12b0865d866ae1b93514870d93ce89"
    var s = document.getElementsByTagName("script")[0]
    s.parentNode.insertBefore(hm, s)
  })();
</script>
<!--vue 前端框架-->
<script src="https://upyun.luckly-mjw.cn/lib/vue.js"></script>
<script>
  document.getElementById('loading') && document.getElementById('loading').remove()
  document.addEventListener("selectionchange", (event) => {
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();
    if (selectedText && window.vueInstance) {
      // 检查选中的文本是否来自 contenteditable
      const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
      if (range) {
        const container = range.commonAncestorContainer;
        const contentEditableBox = window.vueInstance.$refs.contentEditableBox;
        if (contentEditableBox && (contentEditableBox.contains(container) || contentEditableBox === container)) {
          // 排除点击数字高亮的情况
          if (!container.parentElement?.classList?.contains('number-highlight')) {
            window.vueInstance.$data.selectedStr = selectedText;
          }
        }
      }
    }
  });
  window.vueInstance = new Vue({
    el: '#app',

    data() {
      return {
        tips: '快速数学运算器',
        iframeMode: window.parent !== window, // 是否使用 iframe 简洁模式
        // iframeMode: true, // 是否使用 iframe 简洁模式
        sourceStr: localStorage.getItem('math-expression-runner_sourceStr') || '', // 源码字符串
        isShowSourceExp: localStorage.getItem('math-expression-runner_isShowSourceExp') !== 'false', // 是否显示表达式
        sourceExp: '', // 源码字符串的数学表达式
        sourceResult: '', // 整个运算结果
        selectedStr: '', // 选中的字符串
        selectedExp: '', // 选中的字符串的数学表达式
        selectedResult: '', // 选中的表达式的运算结果
        selectedNumbers: new Set(), // 选中的数字集合
        highlightTimeout: null, // 高亮更新的定时器
        testStr: `请输入数学运算表达式，如 1 + 2 * 3
【】支持换行
【】支持划区选中计算，如 1 + 2 * 3 中，选中 2 * 3 则得 6
【】数字间默认执行 “加” 操作，如 1 2 3 则得 6
`,
      }
    },

    watch: {
      sourceStr: function (newValue) {
        localStorage.setItem('math-expression-runner_sourceStr', newValue)
        this.selectedStr = '';
        ({
          exp: this.sourceExp,
          value: this.sourceResult,
        } = this.run(newValue));
        // 更新 contenteditable 内容和高亮显示
        this.$nextTick(() => {
          const displayValue = this.iframeMode ? newValue.replace(/\n/ig, ' ') : newValue;
          const box = this.$refs.contentEditableBox;
          if (box && box.textContent !== displayValue) {
            box.textContent = displayValue;
          }
          this.highlightNumbers();
        });
      },
      selectedStr: function (newValue) {
        ({
          exp: this.selectedExp,
          value: this.selectedResult,
        } = this.run(newValue));
      },
    },

    mounted() {
      ({
        exp: this.sourceExp,
        value: this.sourceResult,
      } = this.run(new URL(location.href).searchParams.get('sourceStr') || this.sourceStr));
      // 从 URL 参数中提取传参
      // 考虑 iframe 的嵌入式使用方式
      // 初始化高亮显示
      this.$nextTick(() => {
        this.updateContentEditable();
        this.highlightNumbers();
      });
    },

    methods: {
      // 更新 contenteditable 的内容
      updateContentEditable() {
        const box = this.$refs.contentEditableBox;
        if (box) {
          const displayValue = this.iframeMode ? this.sourceStr.replace(/\n/ig, ' ') : this.sourceStr;
          if (box.textContent !== displayValue) {
            box.textContent = displayValue;
          }
        }
      },

      // 处理输入事件
      handleInput(event) {
        const text = event.target.textContent || event.target.innerText || '';
        this.sourceStr = text;
        // 延迟更新高亮，避免频繁更新
        clearTimeout(this.highlightTimeout);
        this.highlightTimeout = setTimeout(() => {
          this.highlightNumbers();
        }, 100);
      },

      // 处理粘贴事件
      handlePaste(event) {
        event.preventDefault();
        const text = (event.clipboardData || window.clipboardData).getData('text');
        document.execCommand('insertText', false, text);
      },

      // 处理键盘事件
      handleKeydown(event) {
        // 允许 Tab 键插入制表符
        if (event.key === 'Tab') {
          event.preventDefault();
          document.execCommand('insertText', false, '  ');
        }
      },

      // 高亮显示数字
      highlightNumbers() {
        const box = this.$refs.contentEditableBox;
        if (!box) return;

        // 获取纯文本内容（去除 HTML 标签）
        const text = box.innerText || box.textContent || '';
        const numberRegex = /(\d+\.?\d*)/g;
        let match;
        const numbers = [];
        
        // 找到所有数字及其位置
        while ((match = numberRegex.exec(text)) !== null) {
          numbers.push({
            value: match[0],
            index: match.index,
            length: match[0].length
          });
        }

        // 保存当前光标位置
        const selection = window.getSelection();
        let range = null;
        let cursorOffset = 0;
        
        if (selection.rangeCount > 0) {
          range = selection.getRangeAt(0).cloneRange();
          // 计算光标在文本中的偏移量
          const preCaretRange = range.cloneRange();
          preCaretRange.selectNodeContents(box);
          preCaretRange.setEnd(range.startContainer, range.startOffset);
          cursorOffset = preCaretRange.toString().length;
        }
        
        // 重新构建 HTML
        let html = '';
        let lastIndex = 0;
        let htmlOffset = 0; // HTML 中的字符偏移量
        
        numbers.forEach((num, idx) => {
          // 添加数字前的文本
          const beforeText = text.substring(lastIndex, num.index);
          html += this.escapeHtml(beforeText);
          htmlOffset += beforeText.length;
          
          // 添加数字（带高亮）
          const isSelected = this.selectedNumbers.has(num.value);
          const className = isSelected ? 'number-highlight number-selected' : 'number-highlight';
          html += `<span class="${className}" data-number="${this.escapeHtml(num.value)}" data-index="${idx}">${this.escapeHtml(num.value)}</span>`;
          htmlOffset += num.value.length;
          
          lastIndex = num.index + num.length;
        });
        
        // 添加剩余文本
        html += this.escapeHtml(text.substring(lastIndex));
        
        box.innerHTML = html;
        
        // 恢复光标位置（简化版本，在文本末尾）
        if (range && cursorOffset > 0) {
          try {
            // 尝试将光标设置到接近原位置
            const walker = document.createTreeWalker(
              box,
              NodeFilter.SHOW_TEXT,
              null
            );
            let currentOffset = 0;
            let targetNode = null;
            let targetOffset = 0;
            
            let node;
            while (node = walker.nextNode()) {
              const nodeLength = node.textContent.length;
              if (currentOffset + nodeLength >= cursorOffset) {
                targetNode = node;
                targetOffset = cursorOffset - currentOffset;
                break;
              }
              currentOffset += nodeLength;
            }
            
            if (targetNode) {
              const newRange = document.createRange();
              newRange.setStart(targetNode, Math.min(targetOffset, targetNode.textContent.length));
              newRange.collapse(true);
              selection.removeAllRanges();
              selection.addRange(newRange);
            }
          } catch (e) {
            // 如果恢复失败，将光标放在末尾
            const newRange = document.createRange();
            newRange.selectNodeContents(box);
            newRange.collapse(false);
            selection.removeAllRanges();
            selection.addRange(newRange);
          }
        }
        
        // 绑定点击事件
        this.bindNumberClickEvents();
      },

      // 转义 HTML
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },

      // 绑定数字点击事件
      bindNumberClickEvents() {
        const box = this.$refs.contentEditableBox;
        if (!box) return;

        const numberSpans = box.querySelectorAll('.number-highlight');
        numberSpans.forEach(span => {
          span.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const numberValue = span.getAttribute('data-number');
            this.toggleNumberSelection(numberValue);
          });
        });
      },

      // 切换数字选中状态
      toggleNumberSelection(numberValue) {
        if (this.selectedNumbers.has(numberValue)) {
          this.selectedNumbers.delete(numberValue);
        } else {
          this.selectedNumbers.add(numberValue);
        }
        // 重新高亮
        this.highlightNumbers();
      },

      showSourceExp() {
        this.isShowSourceExp = !this.isShowSourceExp;
        localStorage.setItem('math-expression-runner_isShowSourceExp', this.isShowSourceExp)
      },

       // 拷贝剪切板
      copyToClipboard(content) {

        if (!document.queryCommandSupported('copy')) {
          return false
        }

        let $input = document.createElement('textarea')
        $input.style.opacity = '0'
        $input.value = content
        document.body.appendChild($input)
        $input.select()

        const result = document.execCommand('copy')
        document.body.removeChild($input)
        $input = null

        return result
      },

      jump() {
        window.open('https://blog.luckly-mjw.cn/tool-show/math-expression-runner/index.html?sourceResult=' + this.sourceStr);
      },

      // 重排版，替换换行符
      format() {
        this.sourceStr = this.sourceStr.replace(/\n/ig, ' ').replace(/[ ]+/ig, ' ');
        this.$nextTick(() => {
          this.updateContentEditable();
          this.highlightNumbers();
        });
      },

      // 运行
      run(targetStr) {
        const regex = /[\d\.+\-*/()\s]+/g;
        let preKeyIsNum = false
        let defaultAction = '+'
        const mathStr = targetStr.match(regex)?.join(' ').replace(/\n/ig, ' ').split(' ').map((key => {
          key = key.trim();
          let result = key
          if (!key) {
            return ''
          }
          // 如果上一个是数字，且现在也以数字开头，则添加操作符
          if (/\d/.test(key[0]) && preKeyIsNum) {
            result = defaultAction + key
          }
          preKeyIsNum = /\d/.test(key.slice(-1)[0]) // 最后一位是否是数字
          return result
        })).join('');

        // 输出结果
        try {
          targetStr && window.history.replaceState(null, '', `${location.href.split('?')[0]}?sourceResult=${targetStr}`)
          return {
            exp: mathStr,
            value: eval(mathStr),
          }
        } catch (error) {
          return {
            exp: mathStr,
            value: '表达式错误',
          }
        }
      },
    },
  })
</script>

</html>